<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Snake Game üêç</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
        color: #e2e8f0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        padding: 20px;
        background-attachment: fixed;
      }

      h1 {
        color: #f8fafc;
        margin-bottom: 20px;
        text-shadow: 0 0 15px rgba(255, 255, 255, 0.2);
        font-size: 2.5rem;
        font-weight: 800;
        letter-spacing: -0.5px;
        background: linear-gradient(to right, #a78bfa, #c084fc, #e879f9);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .game-container {
        background: rgba(15, 23, 42, 0.8);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border-radius: 20px;
        padding: 25px;
        box-shadow: 
          0 25px 50px -12px rgba(0, 0, 0, 0.5),
          0 0 0 1px rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        transition: all 0.3s ease;
      }

      canvas {
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        display: block;
        background: rgba(0, 0, 0, 0.2);
        box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.3);
      }

      .info {
        margin-top: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: #cbd5e1;
        font-size: 1.1rem;
        font-weight: 500;
        padding: 12px 16px;
        background: rgba(30, 41, 59, 0.6);
        border-radius: 12px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.05);
      }

      .controls {
        margin-top: 15px;
        color: #94a3b8;
        font-size: 0.9rem;
        text-align: center;
        font-weight: 400;
        letter-spacing: 0.2px;
      }

      .game-over {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(15, 23, 42, 0.95);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        color: white;
        padding: 40px;
        border-radius: 24px;
        text-align: center;
        display: none;
        box-shadow: 
          0 25px 50px -12px rgba(0, 0, 0, 0.5),
          0 0 0 1px rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.1);
        width: 90%;
        max-width: 400px;
        animation: modalAppear 0.4s ease-out;
      }

      @keyframes modalAppear {
        from {
          opacity: 0;
          transform: translate(-50%, -60%);
        }
        to {
          opacity: 1;
          transform: translate(-50%, -50%);
        }
      }

      .game-over h2 {
        margin-bottom: 15px;
        font-size: 2.2rem;
        font-weight: 800;
        background: linear-gradient(to right, #f472b6, #c084fc);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .game-over p {
        margin-bottom: 25px;
        font-size: 1.1rem;
        color: #cbd5e1;
        line-height: 1.6;
      }

      .game-over button {
        background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%);
        color: white;
        border: none;
        padding: 14px 32px;
        border-radius: 16px;
        font-size: 1rem;
        cursor: pointer;
        font-weight: 600;
        letter-spacing: 0.25px;
        transition: all 0.2s ease;
        box-shadow: 0 4px 20px rgba(139, 92, 246, 0.3);
        text-transform: uppercase;
        font-size: 0.9rem;
        font-weight: 700;
      }

      .game-over button:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 30px rgba(139, 92, 246, 0.4);
      }

      .game-over input {
        width: 100%;
        padding: 14px;
        margin-bottom: 20px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        font-size: 1rem;
        text-align: center;
        background: rgba(30, 41, 59, 0.8);
        color: #e2e8f0;
        backdrop-filter: blur(10px);
        transition: all 0.2s ease;
      }

      .game-over input:focus {
        outline: none;
        border-color: #8b5cf6;
        box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2);
      }

      .leaderboard {
        background: rgba(15, 23, 42, 0.8);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border-radius: 20px;
        padding: 25px;
        box-shadow: 
          0 25px 50px -12px rgba(0, 0, 0, 0.5),
          0 0 0 1px rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        min-width: 320px;
        transition: all 0.3s ease;
      }

      .leaderboard h2 {
        color: #f8fafc;
        margin-bottom: 20px;
        text-align: center;
        font-size: 1.5rem;
        font-weight: 700;
        background: linear-gradient(to right, #a78bfa, #f472b6);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .leaderboard-entry {
        display: flex;
        justify-content: space-between;
        padding: 12px 16px;
        margin-bottom: 8px;
        background: rgba(30, 41, 59, 0.6);
        border-radius: 12px;
        font-size: 0.95rem;
        transition: all 0.2s ease;
        border: 1px solid rgba(255, 255, 255, 0.05);
      }

      .leaderboard-entry:hover {
        background: rgba(51, 65, 85, 0.6);
        transform: translateX(4px);
      }

      .leaderboard-entry.top-score {
        background: linear-gradient(135deg, rgba(139, 92, 246, 0.2) 0%, rgba(236, 72, 153, 0.2) 100%);
        border: 1px solid rgba(139, 92, 246, 0.3);
        box-shadow: 0 0 20px rgba(139, 92, 246, 0.2);
      }

      .leaderboard-rank {
        color: #a78bfa;
        font-weight: 700;
        min-width: 35px;
        font-size: 1.1rem;
      }

      .leaderboard-name {
        flex: 1;
        color: #e2e8f0;
        font-weight: 500;
      }

      .leaderboard-score {
        color: #f472b6;
        font-weight: 700;
      }

      .container {
        display: flex;
        gap: 25px;
        align-items: flex-start;
        max-width: 1200px;
        width: 100%;
        justify-content: center;
      }

      .leaderboard.hidden {
        display: none;
      }

      .toggle-button {
        position: fixed;
        bottom: 25px;
        right: 25px;
        background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%);
        color: white;
        border: none;
        padding: 16px 24px;
        border-radius: 30px;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 
          0 10px 25px rgba(139, 92, 246, 0.4),
          0 0 0 1px rgba(255, 255, 255, 0.1);
        z-index: 1000;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .toggle-button:hover {
        transform: translateY(-3px);
        box-shadow: 
          0 15px 35px rgba(139, 92, 246, 0.5),
          0 0 0 1px rgba(255, 255, 255, 0.1);
      }

      .toggle-button:active {
        transform: translateY(-1px);
      }

      @media (max-width: 768px) {
        .container {
          flex-direction: column;
          align-items: center;
        }

        .leaderboard {
          width: 100%;
          max-width: 100%;
          margin-top: 25px;
        }

        h1 {
          font-size: 2rem;
        }

        .game-over {
          padding: 30px 20px;
          margin: 0 15px;
        }

        .game-over h2 {
          font-size: 1.8rem;
        }
      }

      /* Modern scrollbar styling */
      ::-webkit-scrollbar {
        width: 8px;
      }

      ::-webkit-scrollbar-track {
        background: rgba(15, 23, 42, 0.5);
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #8b5cf6, #ec4899);
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(135deg, #7c3aed, #db2777);
      }
    </style>
  </head>
  <body>
    <h1>üêç Snake Game üêç</h1>
    <div
      style="
        position: fixed;
        top: 10px;
        right: 10px;
        background: rgba(255, 255, 255, 0.9);
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        color: #666;
        font-family: monospace;
      "
    >
      v1.0.10
    </div>
    <div class="container">
      <div class="game-container">
        <canvas id="gameCanvas" width="400" height="400"></canvas>
        <div class="info">
          <div>Score: <span id="score">0</span></div>
          <div>High Score: <span id="highScore">0</span></div>
        </div>
        <div
          style="
            margin-top: 10px;
            padding: 10px;
            background: #f8fafc;
            border-radius: 6px;
          "
        >
        </div>
        <div class="controls">Use Arrow Keys or WASD to move</div>
      </div>

      <div class="leaderboard" id="leaderboard">
        <div
          style="
            text-align: center;
            margin-bottom: 10px;
            color: #666;
            font-size: 14px;
          "
        >
          ‚ù§Ô∏è @techfren
        </div>
        <h2>üèÜ Leaderboard</h2>
        <div id="leaderboardList"></div>
      </div>
    </div>

    <button
      class="toggle-button"
      id="toggleButton"
      onclick="toggleLeaderboard()"
    >
      Hide Leaderboard
    </button>

    <div class="game-over" id="gameOver">
      <h2>Game Over!</h2>
      <p>Final Score: <span id="finalScore">0</span></p>
      <p id="deathRoast" style="font-size: 14px; color: #666; margin: 10px 0; font-style: italic;"></p>
      <input
        type="text"
        id="playerName"
        placeholder="Enter your name"
        maxlength="20"
      />
      <button onclick="saveScoreAndRestart()">Save & Play Again</button>
    </div>

    <script>
      const canvas = document.getElementById('gameCanvas');
      const ctx = canvas.getContext('2d');
      const scoreElement = document.getElementById('score');
      const highScoreElement = document.getElementById('highScore');
      const gameOverElement = document.getElementById('gameOver');
      const finalScoreElement = document.getElementById('finalScore');
      const deathRoastElement = document.getElementById('deathRoast');

      const snakeDeathRoasts = [
        "The bot snake sends its regards üêç ‚Äî it left a condolence card and a tiny coffin made of apple seeds.",
        "Skill issue detected üíÄ ‚Äî your reflexes are slower than a snail in molasses wearing lead boots.",
        "Better luck next time, snake food üçé ‚Äî the apple's already planning your funeral.",
        "The bot is now 20% you üò¨ ‚Äî congrats, you've been assimilated into its cold, calculating AI soul.",
        "You just got outplayed by an AI with 3 lines of code ü§ñ ‚Äî those 3 lines have more ambition than your entire life.",
        "Your snake didn't die‚Ä¶ it just realized it was never meant to be more than a snack.",
        "The bot didn't win‚Ä¶ it just waited for you to embarrass yourself. Patience is a virtue you clearly lack.",
        "You played snake like it was a documentary about your own mediocrity.",
        "The AI didn't outsmart you ‚Äî it just watched you make the same mistake 47 times and then sighed.",
        "Your high score? A tragic footnote in the annals of snake history.",
        "You didn't lose‚Ä¶ you just gave the bot a free upgrade to 'Elite Snake Mode'.",
        "The bot's AI is so advanced, it started feeling sorry for you halfway through.",
        "Your snake's death was so dramatic, even the pixels cried.",
        "Congratulations! You've achieved the rare 'Human Error: Snake Edition' achievement.",
        "The bot didn't eat your snake‚Ä¶ it just politely asked for your dignity back.",
        "You thought you were playing a game. The bot was playing existential chess.",
        "Your reflexes are so slow, the apple had time to write a novel before you turned.",
        "The bot's code is simpler than your excuses. And it still won.",
        "You didn't lose to an AI‚Ä¶ you lost to the concept of competence.",
        "Your snake died so hard, it left behind a will: 'Please don't play again.'",
        "The bot didn't need to think ‚Äî it just waited for you to self-destruct.",
        "You're not bad at snake‚Ä¶ you're just a walking obstacle for the AI's greatness.",
        "Your snake's final move? A confused U-turn into a wall. The bot applauded.",
        "The AI didn't calculate your path‚Ä¶ it just predicted your inevitable failure.",
        "You're the reason 'easy mode' was invented.",
        "The bot didn't beat you ‚Äî it just politely corrected your life choices.",
        "Your snake didn't die from hunger‚Ä¶ it died from shame.",
        "Even the game's tutorial had higher IQ than you.",
        "The bot's victory dance? A single pixel blinking 'LOL'.",
        "You didn't lose to an AI ‚Äî you lost to your own inability to learn.",
        "The apple you ate? It's now wearing your ghost as a hat.",
        "Your snake's death was so slow, the bot took a nap and still won.",
        "You're not playing snake‚Ä¶ you're performing a tragedy in 8-bit.",
        "The bot didn't outplay you ‚Äî it just realized you were already defeated before the game started.",
        "Your reflexes are slower than a Windows 95 startup.",
        "The AI's entire strategy: 'Wait for human to panic.' It worked. Again.",
        "You didn't die‚Ä¶ you just became part of the bot's 'Why Humans Suck' presentation.",
        "The bot didn't need to be smart ‚Äî it just needed you to be dumb.",
        "Your snake's death animation was more emotional than your last breakup.",
        "You didn't lose to an AI‚Ä¶ you lost to the laws of physics you refuse to obey.",
        "The bot has a PhD in 'How to Watch Humans Fail Gracefully'.",
        "Your high score is just a polite way of saying 'try again in another life.'",
        "The apple didn't kill you ‚Äî your decision-making did.",
        "You're the reason snakes have nightmares about humans.",
        "The bot didn't eat your snake‚Ä¶ it adopted it as a pet.",
        "You didn't lose‚Ä¶ you just upgraded the bot's confidence level to 'God Mode'.",
        "Your snake's death was so predictable, the bot wrote a haiku about it.",
        "The AI didn't win‚Ä¶ it just accepted your surrender before you did.",
        "You didn't play snake ‚Äî you played 'How to Make an AI Feel Bad for You'.",
        "The bot's code is shorter than your attention span.",
        "You didn't die to a snake‚Ä¶ you died to your own lack of spatial awareness.",
        "The bot didn't calculate your moves ‚Äî it just waited for you to trip over your own ego.",
        "Your snake's final words: 'I regret everything.'",
        "The bot didn't need to be fast‚Ä¶ it just needed you to be wrong.",
        "You're not bad at games ‚Äî you're bad at not being a liability.",
        "The apple you ate? It's now your tombstone.",
        "Your snake didn't die‚Ä¶ it filed for emotional support.",
        "The bot's victory screen? Just a single emoji: ü§°",
        "You didn't lose to AI‚Ä¶ you lost to the fact that even a toaster has better instincts.",
        "The bot didn't outsmart you ‚Äî it just outlasted your will to live.",
        "Your snake's death was so slow, the game paused to give you a pep talk.",
        "You didn't fail‚Ä¶ you just provided the bot with its first real challenge: 'How to stay awake.'",
        "The bot didn't need to think ‚Äî it just needed you to stop breathing.",
        "Your reflexes are so slow, the game had to slow down to match your pace.",
        "The bot didn't beat you ‚Äî it just showed you what happens when you don't try.",
        "You didn't lose to a snake‚Ä¶ you lost to the concept of 'not being terrible'.",
        "The apple didn't kill you ‚Äî your lack of planning did.",
        "Your snake's death was so embarrassing, even the background music paused.",
        "The bot didn't need to be smart ‚Äî it just needed you to be human.",
        "You didn't lose‚Ä¶ you just became a cautionary tale in the game's documentation.",
        "The bot's AI is so advanced, it started feeling guilty‚Ä¶ then ate you anyway.",
        "Your snake didn't die ‚Äî it retired to a life of quiet solitude, far from your incompetence.",
        "You didn't play snake ‚Äî you played 'Guess How Many Times I Can Hit Myself'.",
        "The bot didn't win‚Ä¶ it just witnessed a slow-motion train wreck and took notes.",
        "Your high score? A typo. The game meant to say '0'.",
        "The bot didn't need to calculate your path ‚Äî it just needed you to stop moving.",
        "You didn't lose to an AI‚Ä¶ you lost to the fact that you didn't even try to learn.",
        "The apple you ate? It's now your epitaph.",
        "Your snake's death was so dramatic, the game asked if you wanted to save your progress.",
        "The bot didn't outplay you ‚Äî it just waited for you to give up.",
        "You didn't die‚Ä¶ you just became a glitch in the game's 'Human Behavior' dataset.",
        "The bot's code is shorter than your excuses.",
        "Your reflexes are slower than a sloth on vacation‚Ä¶ with a broken watch.",
        "You didn't lose to a snake‚Ä¶ you lost to your own refusal to evolve.",
        "The bot didn't need to be fast ‚Äî it just needed you to be predictable.",
        "Your snake didn't die‚Ä¶ it was euthanized for the greater good.",
        "The bot didn't win‚Ä¶ it just realized you were never a threat.",
        "You didn't lose to AI ‚Äî you lost to the fact that you didn't even read the manual.",
        "The apple didn't kill you ‚Äî your decision to turn into a wall did.",
        "Your snake's final move? A desperate, chaotic wiggle. The bot yawned.",
        "You didn't lose‚Ä¶ you just gave the bot its first real laugh.",
        "The bot didn't need to think ‚Äî it just needed you to panic.",
        "Your high score is just the game's way of saying 'you tried, but no.'",
        "The bot didn't beat you ‚Äî it just politely reminded you that you're not special.",
        "You didn't die to a snake‚Ä¶ you died to your own arrogance.",
        "The apple you ate? It's now haunting your dreams.",
        "Your snake's death was so slow, the game offered you a free restart‚Ä¶ you declined.",
        "The bot didn't need to calculate ‚Äî it just needed you to be human.",
        "You didn't lose‚Ä¶ you just became the reason the game has a 'Noob Filter'.",
        "The bot's victory screen? Just a single line: 'You're welcome.'",
        "Your reflexes are so slow, the game had to add a 'Human Pause' button.",
        "You didn't lose to AI‚Ä¶ you lost to the concept of 'basic competence'.",
        "The bot didn't eat your snake ‚Äî it just politely asked for your keyboard back.",
        "Your snake didn't die‚Ä¶ it went on strike for better working conditions.",
        "You didn't lose‚Ä¶ you just became a statistic in the bot's 'Why Humans Shouldn't Play Games' report.",
        "The apple didn't kill you ‚Äî your lack of foresight did.",
        "The bot didn't need to be smart ‚Äî it just needed you to be‚Ä¶ you.",
        "Your snake's death was so poetic, the game paused to play a funeral dirge.",
        "You didn't lose to an AI‚Ä¶ you lost to the fact that you're not even a challenge.",
        "The bot didn't win‚Ä¶ it just waited for you to realize you're bad.",
        "Your high score? A sad whisper in the void.",
        "The bot didn't outplay you ‚Äî it just outwaited your will to continue.",
        "You didn't die‚Ä¶ you just became the game's new 'How Not To Play' tutorial.",
        "The apple you ate? It's now your legacy.",
        "Your snake didn't die ‚Äî it just realized it was better off as a pixel.",
        "The bot didn't need to think ‚Äî it just needed you to be predictable, slow, and tragically human.",
        "You didn't lose to AI‚Ä¶ you lost to the fact that you didn't even try to be good.",
        "The bot's code is shorter than your last text message to an ex.",
        "Your reflexes are so slow, the game had to add a 'Human Mode: Glacial' setting.",
        "You didn't die‚Ä¶ you just became the reason the game has a 'Don't Try This' warning.",
        "The bot didn't eat your snake ‚Äî it just politely filed a complaint with the Game Gods.",
        "Your snake's final breath? A sigh. The bot didn't even notice.",
        "You didn't lose to a snake‚Ä¶ you lost to the concept of 'not being a disaster'.",
        "The apple didn't kill you ‚Äî your lack of direction did.",
        "The bot didn't win‚Ä¶ it just smiled and whispered, 'Pathetic.'",
        "Your high score? More of a low point.",
        "You didn't die‚Ä¶ you just became the reason snakes have therapy.",
        "The bot didn't need to calculate your moves ‚Äî it just needed you to exist.",
        "Your snake didn't die‚Ä¶ it retired to a life of peace‚Ä¶ far away from you."
      ];

      const gridSize = 20;
      const tileCount = canvas.width / gridSize;

      let snake = [{ x: 10, y: 10 }];
      let foods = [
        { x: 15, y: 15, type: 'apple' },
        { x: 5, y: 5, type: 'banana' }
      ]; // Two fruits on screen at once
      let dx = 0;
      let dy = 0;
      let score = 0;
      let inputBuffer = null; // Buffer for next direction change
      let lastDirection = { dx: 0, dy: 0 }; // Track last direction
      let highScore = localStorage.getItem('snakeHighScore') || 0;
      let gameRunning = false;
      let gameLoop;
      let gameSpeed = 100; // Starting speed in ms (slower = easier)
      const minSpeed = 40; // Minimum speed (maximum difficulty)
      const speedIncrement = 1; // Speed increase per point (slower acceleration)

      // Leaderboard management - now using server API
      async function fetchLeaderboard() {
        console.log('Fetching leaderboard...');
        try {
          const response = await fetch('/api/snake/scores');
          console.log('Leaderboard response status:', response.status);
          if (response.ok) {
            const data = await response.json();
            console.log('Leaderboard data:', data);
            return data;
          }
        } catch (error) {
          console.error('Error fetching leaderboard:', error);
        }
        return [];
      }

      async function updateLeaderboardDisplay() {
        const leaderboard = await fetchLeaderboard();
        const listElement = document.getElementById('leaderboardList');

        if (leaderboard.length === 0) {
          listElement.innerHTML =
            '<div style="text-align: center; color: #999; padding: 20px;">No scores yet!</div>';
          return;
        }

        listElement.innerHTML = leaderboard
          .map(
            (entry, index) => `
            <div class="leaderboard-entry ${index === 0 ? 'top-score' : ''}">
              <span class="leaderboard-rank">#${index + 1}</span>
              <span class="leaderboard-name">${entry.name}</span>
              <span class="leaderboard-score">${entry.score}</span>
            </div>
          `
          )
          .join('');

        // Update high score display from leaderboard
        if (leaderboard.length > 0) {
          highScore = leaderboard[0].score;
          highScoreElement.textContent = highScore;
        }
      }

      async function addToLeaderboard(name, score) {
        console.log('Attempting to save score:', { name, score });
        try {
          const response = await fetch('/api/snake/scores', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, score }),
          });

          console.log('Response status:', response.status);
          if (response.ok) {
            const data = await response.json();
            console.log('Score saved successfully:', data);
            await updateLeaderboardDisplay();
          } else {
            const errorText = await response.text();
            console.error('Failed to save score:', response.status, errorText);
          }
        } catch (error) {
          console.error('Error posting score:', error);
        }
      }

      // Initialize leaderboard display
      updateLeaderboardDisplay();

      // Toggle leaderboard visibility
      function toggleLeaderboard() {
        const leaderboard = document.getElementById('leaderboard');
        const button = document.getElementById('toggleButton');

        if (leaderboard.classList.contains('hidden')) {
          leaderboard.classList.remove('hidden');
          button.textContent = 'Hide Leaderboard';
        } else {
          leaderboard.classList.add('hidden');
          button.textContent = 'Show Leaderboard';
        }
      }


      function drawGame() {
        // Process buffered input
        if (inputBuffer) {
          dx = inputBuffer.dx;
          dy = inputBuffer.dy;
          lastDirection = { dx, dy };
          inputBuffer = null;
        }

        // Clear canvas
        ctx.fillStyle = '#f0f0f0';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Move snake
        if (dx !== 0 || dy !== 0) {
          const head = { x: snake[0].x + dx, y: snake[0].y + dy };
          snake.unshift(head);

          // Check if snake ate any food
          let ateFood = false;
          for (let i = 0; i < foods.length; i++) {
            if (head.x === foods[i].x && head.y === foods[i].y) {
              score++;
              scoreElement.textContent = score;
              if (score > highScore) {
                highScore = score;
                highScoreElement.textContent = highScore;
                localStorage.setItem('snakeHighScore', highScore);
              }
              // Replace the eaten food with a new one
              placeFoodAt(i);
              ateFood = true;
              break;
            }
          }
          
          if (!ateFood) {
            snake.pop();
          }

          // Check collisions
          if (
            head.x < 0 ||
            head.x >= tileCount ||
            head.y < 0 ||
            head.y >= tileCount
          ) {
            endGame();
            return;
          }

          for (let i = 1; i < snake.length; i++) {
            if (head.x === snake[i].x && head.y === snake[i].y) {
              endGame();
              return;
            }
          }
        }

        // Draw snake
        snake.forEach((segment, index) => {
          ctx.fillStyle = index === 0 ? '#4CAF50' : '#66BB6A';
          ctx.fillRect(
            segment.x * gridSize + 1,
            segment.y * gridSize + 1,
            gridSize - 2,
            gridSize - 2
          );
        });

        // Draw foods (apple and banana emojis)
        ctx.font = `${gridSize - 4}px Arial`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        foods.forEach(food => {
          const emoji = food.type === 'apple' ? 'üçé' : 'üçå';
          ctx.fillText(
            emoji,
            food.x * gridSize + gridSize / 2,
            food.y * gridSize + gridSize / 2
          );
        });
      }

      function placeFoodAt(index) {
        const types = ['apple', 'banana'];
        do {
          foods[index].x = Math.floor(Math.random() * tileCount);
          foods[index].y = Math.floor(Math.random() * tileCount);
        } while (
          snake.some((segment) => segment.x === foods[index].x && segment.y === foods[index].y) ||
          foods.some((f, i) => i !== index && f.x === foods[index].x && f.y === foods[index].y)
        );
        // Keep the same type (apple stays apple, banana stays banana)
        // This way there's always one of each on screen
      }

      function placeFood() {
        // Place both foods initially
        placeFoodAt(0);
        placeFoodAt(1);
      }

      function endGame() {
        gameRunning = false;
        clearInterval(gameLoop);
        finalScoreElement.textContent = score;
        
        // Display random death roast
        const randomRoast = snakeDeathRoasts[Math.floor(Math.random() * snakeDeathRoasts.length)];
        deathRoastElement.textContent = randomRoast;
        
        gameOverElement.style.display = 'block';

        // Focus on name input
        const nameInput = document.getElementById('playerName');
        nameInput.value = localStorage.getItem('snakePlayerName') || '';
        setTimeout(() => nameInput.focus(), 100);
      }

      function saveScoreAndRestart() {
        const nameInput = document.getElementById('playerName');
        const playerName = nameInput.value.trim() || 'Anonymous';

        // Save player name for next time
        localStorage.setItem('snakePlayerName', playerName);

        // Add to leaderboard
        if (score > 0) {
          addToLeaderboard(playerName, score);
        }

        restartGame();
      }

      function restartGame() {
        snake = [{ x: 10, y: 10 }];
        dx = 0;
        dy = 0;
        score = 0;
        gameSpeed = 100; // Reset speed
        scoreElement.textContent = score;
        gameOverElement.style.display = 'none';
        placeFood();
        startGame();
      }

      function startGame() {
        if (!gameRunning) {
          gameRunning = true;
          gameLoop = setInterval(drawGame, gameSpeed);
        }
      }

      // Keyboard controls
      document.addEventListener('keydown', (e) => {
        // Don't capture keys when typing in input field
        if (document.activeElement.tagName === 'INPUT') {
          // Allow Enter to submit name in game over screen
          if (gameOverElement.style.display === 'block' && e.key === 'Enter') {
            saveScoreAndRestart();
          }
          return;
        }

        if (
          !gameRunning &&
          (e.key.startsWith('Arrow') || 'wasd'.includes(e.key.toLowerCase()))
        ) {
          startGame();
        }

        // Buffer input to prevent 180-degree turns
        switch (e.key) {
          case 'ArrowUp':
          case 'w':
          case 'W':
            if (lastDirection.dy === 0) {
              inputBuffer = { dx: 0, dy: -1 };
            }
            break;
          case 'ArrowDown':
          case 's':
          case 'S':
            if (lastDirection.dy === 0) {
              inputBuffer = { dx: 0, dy: 1 };
            }
            break;
          case 'ArrowLeft':
          case 'a':
          case 'A':
            if (lastDirection.dx === 0) {
              inputBuffer = { dx: -1, dy: 0 };
            }
            break;
          case 'ArrowRight':
          case 'd':
          case 'D':
            if (lastDirection.dx === 0) {
              inputBuffer = { dx: 1, dy: 0 };
            }
            break;
        }
      });

      // Initial draw
      drawGame();
    </script>
  </body>
</html>
